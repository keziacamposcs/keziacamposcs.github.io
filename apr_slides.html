<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sistema HandBunny</title>
    <!-- CSS-->
    <link href="css/bootstrap.css" rel="stylesheet">


    <!-- Fim - CSS-->
  </head>
  <body style="background-color: #efefef;">
    <!--Menu-->
    <div class="container">
        <header class="d-flex justify-content-center py-3">
          <ul class="nav nav-pills">
            <li class="nav-item"><a href="index.html" class="nav-link" aria-current="page">Página Inicial</a></li>
            <li class="nav-item"><a href="apr_slides.html" class="nav-link active">Apresentação de Slides</a></li>
            <li class="nav-item"><a href="#" class="nav-link">Desenho em Tela</a></li>
            <li class="nav-item"><a href="#" class="nav-link">?</a></li>
          </ul>
        </header>
    </div>
    <!-- Fim - Menu-->

    <div class="container text-center">
      <div class="row">


      <!-- Coluna 1 Slide-->
        <div class="col">
          <div class="card">
            <h5 class="card-header">Apresentação <span class="badge bg-secondary">PDF somente</span></h5>

            
            <div class="card-body">

              
              <div class="card-body">
                <div class="input-group">
                  <input type="file" class="form-control" id="inputGroupFile" aria-label="Carregar">
                </div>
              </div>

              <div>
                <button class="btn btn-primary" id="prev">Anterior</button>
                <button class="btn btn-primary" id="next">Próximo</button>
                <span>Página: <span id="page_num"></span> / <span id="page_count"></span></span>
              </div>

              
              <div id="viewerContainer" style="width: 100%; height: 100%;">
                <div id="viewer" class="pdfViewer"></div>
              </div>
              
              <canvas id="the-canvas"></canvas>
        

            </div>
          </div>
        </div>
      <!-- Fim - Coluna 1 Slide-->

      <!-- Coluna 2 Cameras-->
        <div class="col">
          <div class="card text-center mb-3">
            <h5 class="card-header">WebCam</h5>
            <div class="card-body">

              <!--Camera webcam-->
                <div class="row">       
                  <video class="input_video"style="width: 100%; height: 100%; display:none"></video>
                </div>
              <!--Fim - Camera webcam-->

              <!--Output com sinais-->
                <div class="row">       
                    <canvas class="output_canvas" style="display: flex; justify-content: center; align-items: center;"></canvas>
                    <div class="caption">Direção do dedo: <span id="finger-direction" value="finger-direction"></span></div>
                </div>
              <!--Fim - Output com sinais-->

            </div>
          </div>
        </div>
      <!-- Fim - Coluna 2 Cameras-->


      </div>
    </div>
    <!-- Javascript-->
    <!-- Bootstrap-->
    <script src="js/bootstrap.min.js" integrity="sha384-3oE51fG8R+q4yjzUHnlgUvVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7TxaGv6f1" crossorigin="anonymous"></script>

    <!-- Mediapipe-->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    
    <!-- Biblioteca do PDF.js -->
    <script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>

    <!--Reconhecimento das maos-->
    <script type="module">
      const videoElement = document.getElementsByClassName('input_video')[0];
      const canvasElement = document.getElementsByClassName('output_canvas')[0];
      const canvasCtx = canvasElement.getContext('2d');
      
      // Função que processa os resultados da detecção de mãos
      function onResults(results)
      {
        canvasCtx.save();
         // Limpa o canvas
        canvasCtx.clearRect( 0, 0, canvasElement.width, canvasElement.height );
        canvasCtx.drawImage( results.image, 0, 0, canvasElement.width, canvasElement.height );
        if (results.multiHandLandmarks)
        {
          for (const landmarks of results.multiHandLandmarks)
          {
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,  {color: '#F1FAEE', lineWidth: 3}  );
            drawLandmarks(canvasCtx, landmarks, {color: '#E63946', lineWidth: 1});

             // verifica a direção do dedo indicador
             const direction = checkFingerDirection(landmarks);
             // Atualiza a legenda com a direção do dedo indicador
             fingerDirectionElement.textContent = checkFingerDirection(landmarks);
             

          }
        }
        canvasCtx.restore();
      }

       // Função que verifica a direção do dedo indicador
       function checkFingerDirection(handLandmarks)
       {
         // posicao do dedo indicador (indice 8) e do polegar (indice 4)
         const thumbPos = handLandmarks[4];
         const indexPos = handLandmarks[8];
 
         if (indexPos.x > thumbPos.x)
         {
           return "Direita";
         }
         else
         {
           return "Esquerda";
         }
       }
      const fingerDirectionElement = document.getElementById('finger-direction');
      // Fim - Função que verifica a direção do dedo indicador

      // Configura o detector de mãos do MediaPipe Hands
      const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
      }});

      hands.setOptions({
        selfieMode: true,
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      hands.onResults(onResults);

      // Inicializa a câmera
      const camera = new Camera(videoElement,
      {
        onFrame: async () => {
          await hands.send({image: videoElement});
        },
        width: 1024,
        height: 768
      });
      camera.start();

      //PDF
      var pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';

      var pdfDoc = null,
      pageNum = 1,
      pageRendering = false,
      pageNumPending = null,
      scale = 0.8,
      canvas = document.getElementById('the-canvas'),
      ctx = canvas.getContext('2d');

      // renderiniza a página
      function renderPage(num)
      {
        pageRendering = true;
        // Using promise to fetch the page
        pdfDoc.getPage(num).then(function(page)
        {
          var viewport = page.getViewport({scale: scale});
          canvas.height = viewport.height;
          canvas.width = viewport.width;

          // Render PDF page into canvas context
          var renderContext = {canvasContext: ctx, viewport: viewport };
          var renderTask = page.render(renderContext);

          // Wait for rendering to finish
          renderTask.promise.then(function()
          {
            pageRendering = false;
            if (pageNumPending !== null)
            {
              renderPage(pageNumPending);
              pageNumPending = null;
            }
          });
        });
        document.getElementById('page_num').textContent = num;
      }

      function queueRenderPage(num)
      {
        if (pageRendering)
        {
          pageNumPending = num;
        }
        else
        {
          renderPage(num);
        }
      }

      // Função que muda para a página anterior
      function onPrevPage()
      {
        if (pageNum <= 1)
        {
          return;
        }
        pageNum--;
        queueRenderPage(pageNum);
      }
      document.getElementById('prev').addEventListener('click', onPrevPage);
      // Fim - Função que muda para a página anterior

      // Função que muda para a proxima página
      function onNextPage()
      {
        if (pageNum >= pdfDoc.numPages) 
        {
          return;
        }
        pageNum++;
        queueRenderPage(pageNum);
      }
      document.getElementById('next').addEventListener('click', onNextPage);
      // Fim - Função que muda para a proxima página

      //Carrega o slide
      document.getElementById('inputGroupFile').addEventListener('change', function()
      {
        var file = this.files[0];
        var fileReader = new FileReader();
        fileReader.onload = function()
        {
          var typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc_)
          {
            pdfDoc = pdfDoc_;
            document.getElementById('page_count').textContent = pdfDoc.numPages;
            renderPage(pageNum);
          });
        };
        fileReader.readAsArrayBuffer(file);
      });

    // Fim - PDF

    </script>
    <!-- Fim - Apresentação em PDF -->

    <!-- Fim - Javascript-->

    </body>
</html>